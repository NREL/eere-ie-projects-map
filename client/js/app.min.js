!function(r){function e(r,e){var t=r||{};for(var n in e)e.hasOwnProperty(n)&&!t[n]&&(t[n]=e[n]);return t}function t(r,e){if(e.crs&&(r.crs={type:"name",properties:{name:e.crs}}),e.bbox&&(r.bbox=e.bbox),e.extraGlobal){r.properties={};for(var t in e.extraGlobal)r.properties[t]=e.extraGlobal[t]}}function n(r){r.geom={};for(var e in r)r.hasOwnProperty(e)&&-1!==f.indexOf(e)&&(r.geom[e]=r[e],delete r[e]);o(r.geom)}function o(r){for(var e in r)r.hasOwnProperty(e)&&("string"==typeof r[e]?c.push(r[e]):"object"==typeof r[e]&&(c.push(r[e][0]),c.push(r[e][1])));if(0===c.length)throw new Error("No geometry attributes specified")}function i(r,e,t){var n={type:"Feature"};return n.geometry=a(r,e),n.properties=t.call(r),n}function a(r,e){var t={};for(var n in e.geom){var o=e.geom[n];"string"==typeof o&&r.hasOwnProperty(o)?(t.type=n,t.coordinates=r[o]):Array.isArray(o)&&r.hasOwnProperty(o[0])&&r.hasOwnProperty(o[1])&&(t.type=n,t.coordinates=[r[o[1]],r[o[0]]])}return t}function u(r){var e;return r.exclude||r.include?r.include?e=function(e){r.include.forEach(function(r){e[r]=this[r]},this)}:r.exclude&&(e=function(e){for(var t in this)this.hasOwnProperty(t)&&-1===c.indexOf(t)&&-1===r.exclude.indexOf(t)&&(e[t]=this[t])}):e=function(r){for(var e in this)this.hasOwnProperty(e)&&-1===c.indexOf(e)&&(r[e]=this[e])},function(){var t={};return e.call(this,t),r.extra&&s(t,r.extra),t}}function s(r,e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}r.version="0.2.0",r.defaults={},r.parse=function(r,o,a){var s,f={type:"FeatureCollection",features:[]},p=e(o,this.defaults);return c.length=0,n(p),s=u(p),r.forEach(function(r){f.features.push(i(r,p,s))}),t(f,p),a&&"function"==typeof a?void a(f):f};var f=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],c=[]}("object"==typeof module?module.exports:window.GeoJSON={});
function init(){Tabletop.init({key:config.url+config.qstring+config.googlekey,callback:render,simpleSheet:!0})}function render(e,a){data=e,linkTitle(data),buildUI(data),renderMap(data),getFilterValues(),renderMapMarkers(data),renderDataTable(data)}function buildHtmlTemplates(e,a){var t=$("script").filter('[data-template="'+e+'"]').html(),r=Handlebars.compile(t);return r(a)}function buildUI(e){var a=$("#ui-controls"),t={};Object.keys(config.uiFilters).forEach(function(a){t[a]=e.map(function(e){return e[a]}).sort().filter(function(e,a,t){return t.indexOf(e)===a})}),a.find("[data-target]").each(function(e,a){var r=$(this).data().target;$(this).append(buildHtmlTemplates(r,t))})}function linkTitle(e){e.forEach(function(e){e.Project='<a target="_blank" href="'+e.Link+'">'+e.Project+"</a>"})}function renderDataTable(e){var a=config.dataHeaders.map(function(e){return{sTitle:e,mDataProp:e}}),t='<"row"<"col-sm-6"l><"col-sm-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-5"p><"col-sm-7"i>>';datatable=$("#"+config.datatableContainer).DataTable({aaData:e,aoColumns:a,dom:t,oLanguage:{sSearch:"Search table:"}})}function renderMap(){L.mapbox.accessToken=config.mapboxToken,map=L.mapbox.map(config.mapContainer).setView(config.mapCenter,config.mapZoom).addLayer(L.mapbox.tileLayer(config.tileLayer))}function getFilterValues(){Object.keys(config.uiFilters).forEach(function(e){var a=$('#ui-controls [data-target="'+e+'"] :checked');config.uiFilters[e].length=0,a.each(function(a){this.value.length&&config.uiFilters[e].push(this.value)})})}function renderMapMarkers(e){var a=0;markerclusters=new L.MarkerClusterGroup({spiderfyOnMaxZoom:!0,singleMarkerMode:!0,disableClusteringAtZoom:20});var t=GeoJSON.parse(e,{Point:["Latitude","Longitude"]}),r=L.mapbox.featureLayer().setGeoJSON(t);r.setFilter(function(e){return filterData(e,config.uiFilters)}),r.eachLayer(function(e){var t="<h3>"+e.feature.properties.Tribe+"</h3>";t+="<h4>"+e.feature.properties.Project+"</h4>",e.bindPopup(t),e.setIcon(L.mapbox.marker.icon({})),markerclusters.addLayer(e),a++}),map.addLayer(markerclusters),a>0?map.fitBounds(markerclusters.getBounds()):(map.setView(config.mapCenter,config.mapZoom),alert("No projects fit the criteria."))}function clearMarkers(e){void 0!==e?map.removeLayer(e):console.log("marker layer was undefined. nothing to remove.")}function filterData(e,a){var t=!0;return Object.keys(a).forEach(function(r){var n=e.properties[r].split(",");t=t&&matches(n,a[r])}),t}function matches(e,a){var t=!0;return a.length&&(t=a.some(function(a){return e.indexOf(a)>=0})),t}function filterDataTable(){Object.keys(config.uiFilters).forEach(function(e){var a=config.dataHeaders.indexOf(e),t=config.uiFilters[e].join("|");datatable.column(a).search(t,!0,!1)}),datatable.draw()}window.onload=function(){init()};var map,datatable,data,markerclusters,config={googlekey:"1PeYaVWqSWABu6kWKI3VF48_iL-YLAyFJIo9j8Hnx73Y",url:"https://docs.google.com/spreadsheet/pub",qstring:"?hl=en_US&hl=en_US&output=html&key=",uiFilters:{State:[],Technology:[],"Project Category":[]},mapCenter:[39.81,-99.84],mapZoom:4,mapboxToken:"pk.eyJ1IjoibnJlbCIsImEiOiJNOTcxYUhZIn0.Jc7TB_G2VQYs9e0S2laKcw",tileLayer:"mapbox.streets",mapContainer:"map",datatableContainer:"datatable",dataHeaders:["Project","Tribe","State","Year","Assistance Type","Project Category","Technology"]};$("#ui-controls").on("change","input, select",function(e){clearMarkers(markerclusters),getFilterValues(),renderMapMarkers(data),filterDataTable()});