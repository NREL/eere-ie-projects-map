function init(){Tabletop.init({key:config.url+config.qstring+config.googlekey,callback:render,simpleSheet:!0})}function render(e,t){data=e,linkTitle(data),buildUI(data),renderMap(data),getFilterValues(),renderMapMarkers(data),renderDataTable(data)}function buildHtmlTemplates(e,t){var r=$("script").filter('[data-template="'+e+'"]').html(),a=Handlebars.compile(r);return a(t)}function buildUI(e){var t=$("#ui-controls"),r={};Object.keys(config.uiFilters).forEach(function(t){r[t]=e.map(function(e){return e[t]}).sort().filter(function(e,t,r){return r.indexOf(e)===t})}),t.find("[data-target]").each(function(e,t){var a=$(this).data().target;$(this).append(buildHtmlTemplates(a,r))})}function linkTitle(e){e.forEach(function(e){e.Project='<a target="_blank" href="'+e.Link+'">'+e.Project+"</a>"})}function renderDataTable(e){var t=config.dataHeaders.map(function(e){return{sTitle:e,mDataProp:e}}),r='<"row"<"col-sm-6"l><"col-sm-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-5"p><"col-sm-7"i>>';datatable=$("#"+config.datatableContainer).DataTable({aaData:e,aoColumns:t,dom:r,oLanguage:{sSearch:"Search table:"}})}function renderMap(){L.mapbox.accessToken=config.mapboxToken,map=L.mapbox.map(config.mapContainer).setView(config.mapCenter,config.mapZoom).addLayer(L.mapbox.tileLayer(config.tileLayer))}function getFilterValues(){Object.keys(config.uiFilters).forEach(function(e){var t=$('#ui-controls [data-target="'+e+'"] :checked');config.uiFilters[e].length=0,t.each(function(t){this.value.length&&config.uiFilters[e].push(this.value)})})}function renderMapMarkers(e){var t=0;markerclusters=new L.MarkerClusterGroup({spiderfyOnMaxZoom:!0,singleMarkerMode:!0,disableClusteringAtZoom:20});var r=GeoJSON.parse(e,{Point:["Latitude","Longitude"]}),a=L.mapbox.featureLayer().setGeoJSON(r);a.setFilter(function(e){return filterData(e,config.uiFilters)}),a.eachLayer(function(e){var r="<h3>"+e.feature.properties.Tribe+"</h3>";r+="<h4>"+e.feature.properties.Project+"</h4>",e.bindPopup(r),e.setIcon(L.mapbox.marker.icon({})),markerclusters.addLayer(e),t++}),map.addLayer(markerclusters),t>0?map.fitBounds(markerclusters.getBounds()):(map.setView(config.mapCenter,config.mapZoom),alert("No projects fit the criteria."))}function clearMarkers(e){void 0!==e?map.removeLayer(e):console.log("marker layer was undefined. nothing to remove.")}function filterData(e,t){var r=!0;return Object.keys(t).forEach(function(a){var n=e.properties[a].split(",");r=r&&matches(n,t[a])}),r}function matches(e,t){var r=!0;return t.length&&(r=t.some(function(t){return e.indexOf(t)>=0})),r}function filterDataTable(){Object.keys(config.uiFilters).forEach(function(e){var t=config.dataHeaders.indexOf(e),r=config.uiFilters[e].join("|");datatable.column(t).search(r,!0,!1)}),datatable.draw()}!function(e){function t(e,t){var r=e||{};for(var a in t)t.hasOwnProperty(a)&&!r[a]&&(r[a]=t[a]);return r}function r(e,t){if(t.crs&&(e.crs={type:"name",properties:{name:t.crs}}),t.bbox&&(e.bbox=t.bbox),t.extraGlobal){e.properties={};for(var r in t.extraGlobal)e.properties[r]=t.extraGlobal[r]}}function a(e){e.geom={};for(var t in e)e.hasOwnProperty(t)&&-1!==l.indexOf(t)&&(e.geom[t]=e[t],delete e[t]);n(e.geom)}function n(e){for(var t in e)e.hasOwnProperty(t)&&("string"==typeof e[t]?u.push(e[t]):"object"==typeof e[t]&&(u.push(e[t][0]),u.push(e[t][1])));if(0===u.length)throw new Error("No geometry attributes specified")}function o(e,t,r){var a={type:"Feature"};return a.geometry=i(e,t),a.properties=r.call(e),a}function i(e,t){var r={};for(var a in t.geom){var n=t.geom[a];"string"==typeof n&&e.hasOwnProperty(n)?(r.type=a,r.coordinates=e[n]):Array.isArray(n)&&e.hasOwnProperty(n[0])&&e.hasOwnProperty(n[1])&&(r.type=a,r.coordinates=[e[n[1]],e[n[0]]])}return r}function c(e){var t;return e.exclude||e.include?e.include?t=function(t){e.include.forEach(function(e){t[e]=this[e]},this)}:e.exclude&&(t=function(t){for(var r in this)this.hasOwnProperty(r)&&-1===u.indexOf(r)&&-1===e.exclude.indexOf(r)&&(t[r]=this[r])}):t=function(e){for(var t in this)this.hasOwnProperty(t)&&-1===u.indexOf(t)&&(e[t]=this[t])},function(){var r={};return t.call(this,r),e.extra&&s(r,e.extra),r}}function s(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e}e.version="0.2.0",e.defaults={},e.parse=function(e,n,i){var s,l={type:"FeatureCollection",features:[]},f=t(n,this.defaults);return u.length=0,a(f),s=c(f),e.forEach(function(e){l.features.push(o(e,f,s))}),r(l,f),i&&"function"==typeof i?void i(l):l};var l=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],u=[]}("object"==typeof module?module.exports:window.GeoJSON={}),window.onload=function(){init()};var map,datatable,data,markerclusters,config={googlekey:"1PeYaVWqSWABu6kWKI3VF48_iL-YLAyFJIo9j8Hnx73Y",url:"https://docs.google.com/spreadsheet/pub",qstring:"?hl=en_US&hl=en_US&output=html&key=",uiFilters:{State:[],Technology:[],"Project Category":[]},mapCenter:[39.81,-99.84],mapZoom:4,mapboxToken:"pk.eyJ1IjoibnJlbCIsImEiOiJNOTcxYUhZIn0.Jc7TB_G2VQYs9e0S2laKcw",tileLayer:"mapbox.streets",mapContainer:"map",datatableContainer:"datatable",dataHeaders:["Project","Tribe","State","Year","Assistance Type","Project Category","Technology"]};$("#ui-controls").on("change","input, select",function(e){clearMarkers(markerclusters),getFilterValues(),renderMapMarkers(data),filterDataTable()});