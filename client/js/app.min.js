!function(r){function e(r,e){var t=r||{};for(var n in e)e.hasOwnProperty(n)&&!t[n]&&(t[n]=e[n]);return t}function t(r,e){if(e.crs&&(r.crs={type:"name",properties:{name:e.crs}}),e.bbox&&(r.bbox=e.bbox),e.extraGlobal){r.properties={};for(var t in e.extraGlobal)r.properties[t]=e.extraGlobal[t]}}function n(r){r.geom={};for(var e in r)r.hasOwnProperty(e)&&-1!==f.indexOf(e)&&(r.geom[e]=r[e],delete r[e]);o(r.geom)}function o(r){for(var e in r)r.hasOwnProperty(e)&&("string"==typeof r[e]?c.push(r[e]):"object"==typeof r[e]&&(c.push(r[e][0]),c.push(r[e][1])));if(0===c.length)throw new Error("No geometry attributes specified")}function i(r,e,t){var n={type:"Feature"};return n.geometry=a(r,e),n.properties=t.call(r),n}function a(r,e){var t={};for(var n in e.geom){var o=e.geom[n];"string"==typeof o&&r.hasOwnProperty(o)?(t.type=n,t.coordinates=r[o]):Array.isArray(o)&&r.hasOwnProperty(o[0])&&r.hasOwnProperty(o[1])&&(t.type=n,t.coordinates=[r[o[1]],r[o[0]]])}return t}function u(r){var e;return r.exclude||r.include?r.include?e=function(e){r.include.forEach(function(r){e[r]=this[r]},this)}:r.exclude&&(e=function(e){for(var t in this)this.hasOwnProperty(t)&&-1===c.indexOf(t)&&-1===r.exclude.indexOf(t)&&(e[t]=this[t])}):e=function(r){for(var e in this)this.hasOwnProperty(e)&&-1===c.indexOf(e)&&(r[e]=this[e])},function(){var t={};return e.call(this,t),r.extra&&s(t,r.extra),t}}function s(r,e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}r.version="0.2.0",r.defaults={},r.parse=function(r,o,a){var s,f={type:"FeatureCollection",features:[]},p=e(o,this.defaults);return c.length=0,n(p),s=u(p),r.forEach(function(r){f.features.push(i(r,p,s))}),t(f,p),a&&"function"==typeof a?void a(f):f};var f=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],c=[]}("object"==typeof module?module.exports:window.GeoJSON={});
!function(){function e(){Tabletop.init({key:g.url+g.qstring+g.googlekey,callback:t,simpleSheet:!0})}function t(e,t){h=e,n(h),o(h),i(h),c(),u(h),r(h)}function a(e,t){var a=$("script").filter('[data-template="'+e+'"]').html(),o=Handlebars.compile(a);return o(t)}function o(e){var t=$("#ui-controls"),o={};Object.keys(g.uiFilters).forEach(function(t){o[t]=e.map(function(e){return e[t]}).sort().filter(function(e,t,a){return a.indexOf(e)===t})}),t.find("[data-target]").each(function(e,t){var n=$(this).data().target;$(this).append(a(n,o))})}function n(e){e.forEach(function(e){e.Project='<a target="_blank" href="'+e.Link+'">'+e.Project+"</a>"})}function r(e){var t=g.dataHeaders.map(function(e){return{sTitle:e,mDataProp:e}}),a='<"row"<"col-sm-6"l><"col-sm-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-5"p><"col-sm-7"i>>';d=$("#"+g.datatableContainer).DataTable({aaData:e,aoColumns:t,dom:a,oLanguage:{sSearch:"Search table:"}})}function i(){L.mapbox.accessToken=g.mapboxToken,m=L.mapbox.map(g.mapContainer).setView(g.mapCenter,g.mapZoom).addLayer(L.mapbox.tileLayer(g.tileLayer))}function c(){Object.keys(g.uiFilters).forEach(function(e){var t=$('#ui-controls [data-target="'+e+'"] :checked');g.uiFilters[e].length=0,t.each(function(t){this.value.length&&g.uiFilters[e].push(this.value)})})}function u(e){var t=0;b=new L.MarkerClusterGroup({spiderfyOnMaxZoom:!0,singleMarkerMode:!0,disableClusteringAtZoom:20});var a=GeoJSON.parse(e,{Point:["Latitude","Longitude"]}),o=L.mapbox.featureLayer().setGeoJSON(a);o.setFilter(function(e){return l(e,g.uiFilters)}),o.eachLayer(function(e){var a="<h3>"+e.feature.properties.Tribe+"</h3>";a+="<h4>"+e.feature.properties.Project+"</h4>",e.bindPopup(a),e.setIcon(L.mapbox.marker.icon({})),b.addLayer(e),t++}),m.addLayer(b),t>0?m.fitBounds(b.getBounds()):(m.setView(g.mapCenter,g.mapZoom),alert("No projects fit the criteria."))}function s(e){void 0!==e?m.removeLayer(e):console.log("marker layer was undefined. nothing to remove.")}function l(e,t){var a=!0;return Object.keys(t).forEach(function(o){var n;e.properties[o]&&(n=e.properties[o].split(","),a=a&&p(n,t[o]))}),a}function p(e,t){var a=!0;return t.length&&(a=t.some(function(t){return e.indexOf(t)>=0})),a}function f(){Object.keys(g.uiFilters).forEach(function(e){var t=g.dataHeaders.indexOf(e),a=g.uiFilters[e].map(function(e){return"^"+e+"$"}),o=a.join("|");d.column(t).search(o,!0,!1)}),d.draw()}window.onload=function(){e()};var m,d,h,b,g={googlekey:"1PeYaVWqSWABu6kWKI3VF48_iL-YLAyFJIo9j8Hnx73Y",url:"https://docs.google.com/spreadsheet/pub",qstring:"?hl=en_US&hl=en_US&output=html&key=",uiFilters:{State:[],Technology:[],Category:[]},mapCenter:[39.81,-99.84],mapZoom:4,mapboxToken:"pk.eyJ1IjoibnJlbCIsImEiOiJNOTcxYUhZIn0.Jc7TB_G2VQYs9e0S2laKcw",tileLayer:"mapbox.streets",mapContainer:"map",datatableContainer:"datatable",dataHeaders:["Project","Tribe","State","Year","Assistance Type","Category","Technology"]};$("#ui-controls").on("change","input, select",function(e){s(b),c(),u(h),f()})}();